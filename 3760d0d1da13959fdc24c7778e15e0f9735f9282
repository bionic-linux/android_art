{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "dda60725_b972fd17",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 1953,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-02-15T18:24:26Z",
      "side": 1,
      "message": "I haven\u0027t looked into this closely. Does art_fd has the same problem?",
      "range": {
        "startLine": 1946,
        "startChar": 2,
        "endLine": 1953,
        "endChar": 3
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "20c29af6_5068fde9",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 1953,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2022-02-15T21:56:02Z",
      "side": 1,
      "message": "The original implementation reuses (or maybe abuses) \"chunk\" to pass the FD. This approach itself is problematic, and is fixed in the new patchset.\n\nAs of whether art_fd can have the same problem... probably not since each chunk can only have one image file, unlike vdex and oat?",
      "parentUuid": "dda60725_b972fd17",
      "range": {
        "startLine": 1946,
        "startChar": 2,
        "endLine": 1953,
        "endChar": 3
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bd517c47_31e2b67b",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 1953,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-02-16T11:05:02Z",
      "side": 1,
      "message": "\u003e As of whether art_fd can have the same problem... probably not since each chunk can only have one image file, unlike vdex and oat?\n\nNo, each chunk can have multiple image files, one for each jar, just like vdex and oat.\n\n```\n$ adb shell ls /apex/com.android.art/javalib/x86_64\nboot-apache-xml.art\nboot-apache-xml.oat\nboot-apache-xml.vdex\nboot-bouncycastle.art\nboot-bouncycastle.oat\nboot-bouncycastle.vdex\nboot-core-libart.art\nboot-core-libart.oat\nboot-core-libart.vdex\nboot-okhttp.art\nboot-okhttp.oat\nboot-okhttp.vdex\nboot.art\nboot.oat\nboot.vdex\n```",
      "parentUuid": "20c29af6_5068fde9",
      "range": {
        "startLine": 1946,
        "startChar": 2,
        "endLine": 1953,
        "endChar": 3
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c481efcc_dac42757",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 1953,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2022-02-18T01:54:53Z",
      "side": 1,
      "message": "I haven\u0027t been able to test my change for two days due to some weird device problem... So let me post my question to see if you any thoughts first.\n\nThere are two loop of locations.size(), one at L3176, the other L3234 (this PS6).  The same function has a chunk as its parameter.\n\nThe first loop std::move\u0027s chunk.art_fd, so that only the first location will come with a valid art_fd.  The second loop calls OpenOatFile with the i-th oat_fd and vdex_fd.\n\nI\u0027m not sure what is the \"correct\" behavior. Maybe passing `boot_class_path_image_fds_[chunk.start_index + i]` to `Load` in the loop? If not, what should it be?",
      "parentUuid": "bd517c47_31e2b67b",
      "range": {
        "startLine": 1946,
        "startChar": 2,
        "endLine": 1953,
        "endChar": 3
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "877aac21_6e83c89c",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 1953,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-02-18T11:10:21Z",
      "side": 1,
      "message": "The correct behavior is the same as the one for oat and vdex: if `chunk.art_fd` exists, use it and DCHECK that `locations.size()` is 1, otherwise, use `boot_class_path_image_fds_[chunk.start_index + i]`.",
      "parentUuid": "c481efcc_dac42757",
      "range": {
        "startLine": 1946,
        "startChar": 2,
        "endLine": 1953,
        "endChar": 3
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21eca54d_6b537018",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 3247,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-02-15T18:24:26Z",
      "side": 1,
      "message": "This still looks tricky. `chunk.vdex_fd` is referenced in a for loop, while it can only be used once. That\u0027s exactly the reason that caused b/210909223, and it can still cause similar problems in the future. I\u0027d add a DCHECK to make sure that the for loop has only one iteration (i.e., `locations.size() \u003d\u003d 1`) when `chunk.vdex_fd` is set, so that similar problems can be caught in our debug builds in the future.\n\nSame for oat_fd and art_fd as well.",
      "range": {
        "startLine": 3245,
        "startChar": 6,
        "endLine": 3247,
        "endChar": 7
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9e8498c_ec3b0705",
        "filename": "runtime/gc/space/image_space.cc",
        "patchSetId": 6
      },
      "lineNbr": 3247,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2022-02-15T21:56:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "21eca54d_6b537018",
      "range": {
        "startLine": 3245,
        "startChar": 6,
        "endLine": 3247,
        "endChar": 7
      },
      "revId": "3760d0d1da13959fdc24c7778e15e0f9735f9282",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}