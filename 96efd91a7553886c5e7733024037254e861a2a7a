{
  "comments": [
    {
      "key": {
        "uuid": "1a84f608_cd427bbe",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1047769
      },
      "writtenOn": "2020-08-06T16:35:48Z",
      "side": 1,
      "message": "probably would be better to do something like\n\n  for (art::ArtField\u0026 af : klass-\u003eGetIFields()) {\n    if (af.IsPrimitiveType()) {\n      continue;\n    }\n    fn(af.GetOffset());\n  }\n\nAlso this only gets fields declared on the exact class passed in. Is this intentional?\n\nIf not you probably want something like\n  do {\n    for (art::ArtField\u0026 af : klass-\u003eGetIFields()) {\n      if (af.IsPrimitiveType()) {\n        continue;\n      }\n      fn(af.GetOffset());\n    }\n  } while (!(klass \u003d klass-\u003eGetSuperClass()).IsNull())",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ae80ac1a_0ae29ca2",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1268571
      },
      "writtenOn": "2020-08-07T09:00:18Z",
      "side": 1,
      "message": "Your code has different behaviour (i.e. does not generate a useful profile). I used the pattern from Object::VisitInstanceReferences: https://cs.android.com/android/platform/superproject/+/master:art/runtime/mirror/object-inl.h?q\u003d%22for%20(size_t%20i%20%3D%200u;%20i%20%3C%20num_reference_fields;%20%2B%2Bi)%20%7B%22\n\nYes, that is intentional. We walk the superclass hierarchy after the fact, this way we use less space.",
      "parentUuid": "1a84f608_cd427bbe",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "da7a4de3_e9e21174",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1047769
      },
      "writtenOn": "2020-08-07T17:22:26Z",
      "side": 1,
      "message": "for (art::ArtField\u0026 af : klass-\u003eGetIFields()) {\n    if (af.IsPrimitiveType() || field_offset.Uint32Value() \u003d\u003d art::mirror::Object::ClassOffset().Uint32Value()) {\n      continue;\n    }\n    fn(af.GetOffset());\n  }\n\nmaybe?\n\nDoing it your way relies on the way our class-linker lays out object fields. Especially since this is so far from the class-linker it\u0027s not the greatest to rely on this.",
      "parentUuid": "ae80ac1a_0ae29ca2",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8f876949_c8acd6c1",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1268571
      },
      "writtenOn": "2020-08-11T10:37:14Z",
      "side": 1,
      "message": "That still does not give the correct profile. It seems like ifields_ is not what we need (but I am not sure what it actually is).",
      "parentUuid": "da7a4de3_e9e21174",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e26d561c_c705a55d",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1047769
      },
      "writtenOn": "2020-08-11T16:09:15Z",
      "side": 1,
      "message": "That\u0027s really strange. Lokesh, mathieuc, can either of you figure out why iterating over GetIFields would not find all field offsets?",
      "parentUuid": "8f876949_c8acd6c1",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "714f73a4_4288b4cb",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2020-08-11T17:22:01Z",
      "side": 1,
      "message": "I agree with Alex. Not sure why GetIFields would be an issue.",
      "parentUuid": "e26d561c_c705a55d",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6eca8f5c_7b739d1b",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1047769
      },
      "writtenOn": "2020-08-11T20:56:13Z",
      "side": 1,
      "message": "Can you maybe post what you expect vs what you get?\n\nThe only thing I could think that might be different is that offset might not monotonically increase but I\u0027m not even sure if that\u0027s true.",
      "parentUuid": "714f73a4_4288b4cb",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3340e22c_06a9b038",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1015378
      },
      "writtenOn": "2020-08-11T21:39:04Z",
      "side": 1,
      "message": "I don\u0027t have any idea why that wouldn\u0027t work, I agree that it would be good to see how the results are wrong.",
      "parentUuid": "6eca8f5c_7b739d1b",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c4a081a0_67047012",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 506,
      "author": {
        "id": 1268571
      },
      "writtenOn": "2020-08-14T17:03:06Z",
      "side": 1,
      "message": "Got some time to look into this again; sorry for taking so long.\n\nThe resulting file is much larger (28 M vs 40 M) for essentially the same profile, but does parses as a profile (I messed up something with parsing, sorry). I will look closer at the difference between the profiles â€“ the whole point of this CL is to reduce the profile size.",
      "parentUuid": "3340e22c_06a9b038",
      "range": {
        "startLine": 506,
        "startChar": 0,
        "endLine": 506,
        "endChar": 54
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "243fe9ed_75c6ab47",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 646,
      "author": {
        "id": 1047769
      },
      "writtenOn": "2020-08-11T20:56:13Z",
      "side": 1,
      "message": "It seems wrong that you would need this.",
      "range": {
        "startLine": 646,
        "startChar": 0,
        "endLine": 646,
        "endChar": 53
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "746b2cf5_ed9dae95",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 712,
      "author": {
        "id": 1386032
      },
      "writtenOn": "2020-08-06T09:45:49Z",
      "side": 1,
      "message": "nit: probably reads nicer to check if reference_field_ids is not empty?",
      "range": {
        "startLine": 712,
        "startChar": 22,
        "endLine": 712,
        "endChar": 36
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c8c03e89_ad9f6f5d",
        "filename": "perfetto_hprof/perfetto_hprof.cc",
        "patchSetId": 6
      },
      "lineNbr": 712,
      "author": {
        "id": 1268571
      },
      "writtenOn": "2020-08-06T09:55:54Z",
      "side": 1,
      "message": "Hmm I think this is one fewer indirection to reason. Leaving it like this.",
      "parentUuid": "746b2cf5_ed9dae95",
      "range": {
        "startLine": 712,
        "startChar": 22,
        "endLine": 712,
        "endChar": 36
      },
      "revId": "96efd91a7553886c5e7733024037254e861a2a7a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}