{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "bbbd70fa_c6fc271d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2024-01-10T22:45:33Z",
      "side": 1,
      "message": "artd is a lazy service, so presumably this would break that? (I haven\u0027t read the rest of the patch)",
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4053662e_42a78ce2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-11T12:57:30Z",
      "side": 1,
      "message": "No, we drop the cache when there is no more pin within a timeout. See the comment on ArtdRefCache.java line 114.",
      "parentUuid": "bbbd70fa_c6fc271d",
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "69a5a9b9_4027502b",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 44,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T19:30:20Z",
      "side": 1,
      "message": "Might be worth a brief comment as to why 5s was chosen.",
      "range": {
        "startLine": 44,
        "startChar": 43,
        "endLine": 44,
        "endChar": 47
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "411acb22_6525842b",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 44,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:41:27Z",
      "side": 1,
      "message": "I arbitrarily chose it. Do you by any chance know the typical interval between ArtManagerLocal.dexoptPackage calls in real CUJs like device setup or restoring from backup?",
      "parentUuid": "69a5a9b9_4027502b",
      "range": {
        "startLine": 44,
        "startChar": 43,
        "endLine": 44,
        "endChar": 47
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e2ab19c_819d785a",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 82,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T18:34:13Z",
      "side": 1,
      "message": "Any sense for how many clients call this directly without the pin? I imagine most cases are now handled, just curious.",
      "range": {
        "startLine": 82,
        "startChar": 17,
        "endLine": 82,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "13227f23_9450801e",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 82,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:08:23Z",
      "side": 1,
      "message": "I would say none.",
      "parentUuid": "9e2ab19c_819d785a",
      "range": {
        "startLine": 82,
        "startChar": 17,
        "endLine": 82,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b27621bd_5264bf74",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 82,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T19:30:20Z",
      "side": 1,
      "message": "I guess that could sneak in in the future? In which case, a stray call to getArtd() would end up indefinitely keeping artd alive until another call gets made to fetch the pin (and the pin also gets closed properly)?",
      "parentUuid": "13227f23_9450801e",
      "range": {
        "startLine": 82,
        "startChar": 17,
        "endLine": 82,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "719a350e_70dc2361",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 82,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:41:27Z",
      "side": 1,
      "message": "No, a call to getArtd() will not put the handle in the cache if there is no pin.",
      "parentUuid": "b27621bd_5264bf74",
      "range": {
        "startLine": 82,
        "startChar": 17,
        "endLine": 82,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "32cb9603_09f07978",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 118,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T18:34:13Z",
      "side": 1,
      "message": "Does it improve ergonomics/readability if the Pin exposes a getter for the Artd handle?",
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c109a7a5_b5553c58",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 118,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:08:23Z",
      "side": 1,
      "message": "We get the artd handle in multiple levels. If the getter is exposed by the pin, we\u0027ll have to pass the pin down to all those levels, so I think it adds too much complexity.\n\nArtManagerLocal is always the top level because all our API entrypoints are there. What I\u0027m doing is creating a pin at that level so all the getArtd() calls in the levels below it are covered.",
      "parentUuid": "32cb9603_09f07978",
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6a8de28a_cdcbef08",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 123,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T19:30:20Z",
      "side": 1,
      "message": "Should we have some stronger checks on close() being called? Otherwise we\u0027ll never drop the ref. CloseGuard maybe? Alternatively, you could use a cleaner as the backstop to ensure the ref counts are balanced.\n\nAnother approach would be to combine this debounce clear behavior with storing mArtd in a WeakRef. It\u0027s no worse than current behavior that relies on GC, avoids any leaks, and also allows the binder death callback.",
      "range": {
        "startLine": 123,
        "startChar": 12,
        "endLine": 123,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ab430ad_68be3ac3",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 123,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:41:27Z",
      "side": 1,
      "message": "Thank for the suggestions! I\u0027ll explore those.",
      "parentUuid": "6a8de28a_cdcbef08",
      "range": {
        "startLine": 123,
        "startChar": 12,
        "endLine": 123,
        "endChar": 24
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e6c864c4_3ec359e6",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 177,
      "author": {
        "id": 1064003
      },
      "writtenOn": "2024-01-16T18:34:13Z",
      "side": 1,
      "message": "Does this end up creating a new thread? Can we just use the system_server BG executor? https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/com/android/internal/os/BackgroundThread.java;drc\u003da15d36b097385cb03a86cb681f97075316293663;l\u003d69",
      "range": {
        "startLine": 177,
        "startChar": 19,
        "endLine": 177,
        "endChar": 28
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3a2ab130_2cdc3c8e",
        "filename": "libartservice/service/java/com/android/server/art/ArtdRefCache.java",
        "patchSetId": 3
      },
      "lineNbr": 177,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-01-16T19:08:23Z",
      "side": 1,
      "message": "We need a ScheduledExecutorService for the debouncer, not a normal executor. Yes, this ScheduledExecutorService creates a new thread, but we have throttled the calls to it by aosp/2887708, so I think it\u0027s fine?",
      "parentUuid": "e6c864c4_3ec359e6",
      "range": {
        "startLine": 177,
        "startChar": 19,
        "endLine": 177,
        "endChar": 28
      },
      "revId": "4b80442b859bb2d465f38686cadec9ebda00b650",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}