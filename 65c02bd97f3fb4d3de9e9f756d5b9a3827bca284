{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "24727dde_b2d2fe99",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 1301,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-01T18:33:08Z",
      "side": 1,
      "message": "Please move it above (after line 1291)",
      "range": {
        "startLine": 1301,
        "startChar": 2,
        "endLine": 1301,
        "endChar": 25
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "42d57a3c_c8310cd5",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 1301,
      "author": {
        "id": 1151059
      },
      "writtenOn": "2021-09-02T02:38:42Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "24727dde_b2d2fe99",
      "range": {
        "startLine": 1301,
        "startChar": 2,
        "endLine": 1301,
        "endChar": 25
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0f4442d8_d3a24600",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-01T18:33:08Z",
      "side": 1,
      "message": "Please move this to function AllocateInternalWithGc(). Also, please remove the condition for clear_soft_reference.\n\nApplication threads reach AllocateInternalWithGc() when they are unable to allocate due to heap being full. The problem, however, is that many threads could be in this function, and we want to increment only once every time this situation arises.\n\nHans, any suggestion on how to handle concurrency here? What if we were to increment inside some critical if the gc-cause is allocation? But again, how do we avoid multiple increments as we perform multiple GCs in this function?",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "120b0c6e_f3796b2c",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1042828
      },
      "writtenOn": "2021-09-01T19:31:37Z",
      "side": 1,
      "message": "I\u0027d make the counter atomic, and increment it (with fetch_add()) immediately after\n\nhttps://cs.android.com/android/platform/superproject/+/master:art/runtime/gc/heap.cc;l\u003d1909?q\u003dAllocateInternalWithGc ,\n\nThat\u0027s not ideal, in that, as Lokesh said, we can start this kind of GC from multiple threads, and have this happen more than once for a single near-OOM situation. But there is already a TODO there to fix that. And that\u0027s a harder problem.\n\nProbably more of these counters should eventually be atomic, so this moves us in the right direction.",
      "parentUuid": "0f4442d8_d3a24600",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "679b7659_50874841",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-01T19:43:33Z",
      "side": 1,
      "message": "Sounds good to me as well.",
      "parentUuid": "120b0c6e_f3796b2c",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7cd27aca_c2e14d85",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-02T17:36:36Z",
      "side": 1,
      "message": "Sekyeong, Can you make this change as well so that we can approve the CL? Basically, change pre_oome_gc_count_ into an \u0027Atomic\u003cuint64_t\u003e and then update it the way Hans suggested in the second comment above.",
      "parentUuid": "679b7659_50874841",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e2754e2_7b1c3c6d",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1151059
      },
      "writtenOn": "2021-09-03T02:19:01Z",
      "side": 1,
      "message": "Atomic\u003cuint64_t\u003e pre_oome_gc_count_;\n\nChanged to the above.\nPlease review about that, and if you have more suggestion, please feel free to share to me.",
      "parentUuid": "7cd27aca_c2e14d85",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "50136d0b_5f8e3ff8",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-03T15:34:06Z",
      "side": 1,
      "message": "Please remove this code. And add the following at the location that Hans mentioned in his comment above:\n\npre_oome_gc_count_.fetch_add(1, std::memory_order_relaxed);",
      "parentUuid": "8e2754e2_7b1c3c6d",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e120869c_2f1ef8ac",
        "filename": "runtime/gc/heap.cc",
        "patchSetId": 2
      },
      "lineNbr": 2732,
      "author": {
        "id": 1258954
      },
      "writtenOn": "2021-09-09T00:18:16Z",
      "side": 1,
      "message": "Sekyeong, can you please make this change so that we can review and eventually merge this CL",
      "parentUuid": "50136d0b_5f8e3ff8",
      "range": {
        "startLine": 2730,
        "startChar": 2,
        "endLine": 2732,
        "endChar": 3
      },
      "revId": "65c02bd97f3fb4d3de9e9f756d5b9a3827bca284",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}