{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ec9200b7_5c20f4be",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-07-16T21:29:34Z",
      "side": 1,
      "message": "I think I need a refresher on shared libraries. I thought they\u0027re (always?) in partition-global locations like \u003cpartition\u003e/framework and not really owned by any package. So:\n\n1. Isn\u0027t it possible to detect them by path prefix alone?\n\n2. If that\u0027s not a good idea, then how common is it that a package loads another package\u0027s shared library dependency? Iow, isn\u0027t it enough to do this check only for the loading package?",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f955e844_c52d4279",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-07-16T22:14:58Z",
      "side": 1,
      "message": "\u003e Isn\u0027t it possible to detect them by path prefix alone?\n\nNo. First, there are two types of shared libraries: apk and jar. The former is like a normal package, located in `/system/app`, etc. if it\u0027s preinstalled, or `/data/app/...` if it\u0027s updated. The latter can be at any location, specified by xml files at `/system/etc/permissions`.\n\n\u003e If that\u0027s not a good idea, then how common is it that a package loads another package\u0027s shared library dependency? Iow, isn\u0027t it enough to do this check only for the loading package?\n\nIf a package loads another package\u0027s primary dex file, then the owning package\u0027s shared libraries are also loaded because they are in the primary dex file\u0027s class loader.",
      "parentUuid": "ec9200b7_5c20f4be",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "37669f1a_c811d585",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-07-17T19:09:12Z",
      "side": 1,
      "message": "Ok, but when it\u0027s not a shared library this will recheck the same shared libraries used by many apps over and over again, which is a bit of a pity.\n\nIf it wasn\u0027t for the other case I\u0027ve added a comment on below, I\u0027d argue it\u0027s better to just ignore the shared libs and instead rely on the cache to speed up the non-recording of the popular ones.\n\nAs it is I can\u0027t think of a way to improve this appreciably (can\u0027t find any hint that PackageManager even maintains a data structure of all shared libs).",
      "parentUuid": "f955e844_c52d4279",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "28e1b848_d478a4d2",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-07-17T21:15:52Z",
      "side": 1,
      "message": "I feel the same unfortunate as you do that we will probably recheck the same shared libraries used by many apps over and over again, but I don\u0027t see a better way either. I think PackageManager must be maintaining a data structure of all shared libs because I\u0027ve seen it printing all shared libs in dumpsys, but I just can\u0027t find an API that returns this information.\n\nHowever, the reason I added this early return is not for the other case that you commented. Instead, it\u0027s for avoiding the penalty of cache miss. If we just ignore them and instead rely on the cache, since jar libraries don\u0027t have package names, we won\u0027t record them in the cache and we\u0027ll get a cache miss every time.",
      "parentUuid": "37669f1a_c811d585",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9614a052_78da7a74",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-07-18T15:11:09Z",
      "side": 1,
      "message": "\u003e since jar libraries don\u0027t have package names, we won\u0027t record them in the cache and we\u0027ll get a cache miss every time\n\nBut now with the cache changed to use the dex paths as keys, isn\u0027t it possible?",
      "parentUuid": "28e1b848_d478a4d2",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0435ba96_2a6dd3c0",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2024-07-19T10:40:45Z",
      "side": 1,
      "message": "I still don\u0027t see how it\u0027s possible. After the change, we still need a package name in order to call `checkForPackage`. If we don\u0027t call it, we may hurt correctness.",
      "parentUuid": "9614a052_78da7a74",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9cd94cdd_a0a9f800",
        "filename": "libartservice/service/java/com/android/server/art/DexUseManagerLocal.java",
        "patchSetId": 1
      },
      "lineNbr": 519,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-07-19T15:00:30Z",
      "side": 1,
      "message": "But didn\u0027t you say we still find the shared library as a normal package sooner or later? Which libraries is it that we don\u0027t get package names for?\n\nIf they\u0027re in read-only partitions we don\u0027t need to recheck them anyway, so wouldn\u0027t we get pretty far by just matching well known system partition prefixes like /system(_ext), /product, and /vendor?\n\nNote you can provide a package in the `TYPE_DONT_RECORD` return on line 559, to recheck non-existence within existing package directories.",
      "parentUuid": "0435ba96_2a6dd3c0",
      "revId": "76f1d0c6c490b6fe5a88cd9eff0b01a1142cae54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}