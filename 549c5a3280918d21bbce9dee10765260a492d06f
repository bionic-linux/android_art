{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "6e5ba72d_98c45970",
        "filename": "libartservice/service/java/com/android/server/art/ArtManagerLocal.java",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2023-11-27T22:49:20Z",
      "side": 1,
      "message": "I assume this is in practice the only pass at boot, so the reported progress will still reflect the overall progress. However, it\u0027s prone to problems if we extend the passes further.\n\nCan\u0027t you add another @hide field to `OperationProgress` for the current pass instead?\n\nI think that should be fine as long as it\u0027s not part of the API, but if we can\u0027t do that due to API guidelines, we may be better off with a separate internal progress callback that\u0027s not conflated with the exposed one (except we could have an internal wrapper for this external `progressCallback` that implements the internal API).",
      "range": {
        "startLine": 882,
        "startChar": 27,
        "endLine": 882,
        "endChar": 45
      },
      "revId": "549c5a3280918d21bbce9dee10765260a492d06f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1626f318_3801cf0f",
        "filename": "libartservice/service/java/com/android/server/art/ArtManagerLocal.java",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2023-11-28T11:23:24Z",
      "side": 1,
      "message": "If there are multiple passes taking place on boot, I will create callbacks to listen to the progress of each pass, blend the progresses into an overall progress, and report it through the progress callback passed by the user. It can be done without changing the data structure.",
      "parentUuid": "6e5ba72d_98c45970",
      "range": {
        "startLine": 882,
        "startChar": 27,
        "endLine": 882,
        "endChar": 45
      },
      "revId": "549c5a3280918d21bbce9dee10765260a492d06f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b6f05336_55060ae1",
        "filename": "libartservice/service/java/com/android/server/art/ArtManagerLocal.java",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2023-11-28T11:51:12Z",
      "side": 1,
      "message": "Why then is there one callback per pass, instead of just having the pass in `OperationProgress` or as an argument to the callback? It seems clunky to me to encode a data parameter in the entry point, and the for loops over `BATCH_DEXOPT_PASSES` building lambdas below are examples of it - the callback code is the same for all passes and the pass is just used as data in it, so there seems to be no benefit.",
      "parentUuid": "1626f318_3801cf0f",
      "range": {
        "startLine": 882,
        "startChar": 27,
        "endLine": 882,
        "endChar": 45
      },
      "revId": "549c5a3280918d21bbce9dee10765260a492d06f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5f76a62c_fafa8b21",
        "filename": "libartservice/service/java/com/android/server/art/ArtManagerLocal.java",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2023-11-28T12:10:08Z",
      "side": 1,
      "message": "1. The progress callback is called by `DexoptHelper`, who\u0027s agnostic of the current pass. Adding the current pass as a field in `OperationProgress` means we\u0027ll have to pass the current pass to `DexoptHelper`. That seems clunky to me.\n\n2. Adding the current pass as a field in `OperationProgress` makes it error-prone. After the change, the class is used for two different purposes: (1) reporting the overall progress to API users; (2) reporting pass-specific progress to internal users. If one mixes up the usage of those two, the API users will see a non-monotonic overall progress.\n\n3. To avoid 2, we have to add a separate internal progress callback, but that\u0027s over-engineering. For now, I don\u0027t foresee the need to have multiple passes on boot, so I prefer not to over-engineer it.",
      "parentUuid": "b6f05336_55060ae1",
      "range": {
        "startLine": 882,
        "startChar": 27,
        "endLine": 882,
        "endChar": 45
      },
      "revId": "549c5a3280918d21bbce9dee10765260a492d06f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}