{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d87c57fc_1cc65432",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1889741
      },
      "writtenOn": "2022-11-24T09:35:58Z",
      "side": 1,
      "message": "We can construct a case where we have `If(Phi(0,4))` in DCE which gets optimized to `If(0)` and `If(4)` (see .smali code in 2246-). We then crash since we expect only `0` or `1` values. This wasn\u0027t detected by graph checker in earlier passes since the `4` was an input to a `Phi` (https://cs.android.com/android/platform/superproject/+/master:art/compiler/optimizing/graph_checker.cc;l\u003d981;drc\u003d434d968b4af0bc8af9889170250bee3e08839bea).\n\nSo, we must consider IntConstants which are neither `0` nor `1` and the question is how to interpret them. One possibility is to use `0` as `false` and the rest as `true`. This is how the code behaves when calling `booleanValueOf(Z)` in .smali with int values, even in tip of tree.\n\nAs a note, I think that we can still guarantee that `DataType::Type::kBool` values are going to be only `0` or `1` (The Phi has `kInt32` type).",
      "revId": "ca268841de1450aa72c542d44895b920d13ea77c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cce636bc_e0967285",
        "filename": "test/2246-checker-smali-value-of/smali/b_252803203.smali",
        "patchSetId": 1
      },
      "lineNbr": 48,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2022-11-29T17:01:51Z",
      "side": 1,
      "message": "If this passes verification, what about storing `Phi(0,256)` in a boolean field and reading it back? I think LSE would replace the load with the `Phi` without a type conversion, see `FindOrAddTypeConversionIfNecessary`.",
      "range": {
        "startLine": 48,
        "startChar": 52,
        "endLine": 48,
        "endChar": 53
      },
      "revId": "ca268841de1450aa72c542d44895b920d13ea77c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6a5b195b_ceb01e6b",
        "filename": "test/2246-checker-smali-value-of/smali/b_252803203.smali",
        "patchSetId": 1
      },
      "lineNbr": 48,
      "author": {
        "id": 1889741
      },
      "writtenOn": "2022-11-29T17:11:43Z",
      "side": 1,
      "message": "That also passes verification and there\u0027s no type conversion. I changed `const/4` to `const/16` and updated the CHECKER tests and it passes.\n\nDoesn\u0027t the first line of `FindOrAddTypeConversionIfNecessary` show that we don\u0027t type convert to boolean?https://cs.android.com/android/platform/superproject/+/master:art/compiler/optimizing/load_store_elimination.cc;l\u003d713;drc\u003d434d968b4af0bc8af9889170250bee3e08839bea",
      "parentUuid": "cce636bc_e0967285",
      "range": {
        "startLine": 48,
        "startChar": 52,
        "endLine": 48,
        "endChar": 53
      },
      "revId": "ca268841de1450aa72c542d44895b920d13ea77c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c4ca6310_3c0bd4af",
        "filename": "test/2246-checker-smali-value-of/smali/b_252803203.smali",
        "patchSetId": 1
      },
      "lineNbr": 48,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2022-11-29T17:51:26Z",
      "side": 1,
      "message": "The `FindOrAddTypeConversionIfNecessary` is about inserting narrowing type conversions when we eliminate loads, for example\n\n    byteField \u003d intVar1;\n    int intVar2 \u003d byteField;  // Replace with TypeConversion(intVar1, byte).\n\nIf we\u0027re not inserting a type conversion for boolean fields, than for\n\n    booleanField \u003d Phi(0, 256);\n    boolean booleanVar \u003d booleanField;\n\nwe shall replace `booleanVar` with `Phi(0,256)` even though actual store and load would remove the higher bits and give us a plain 0.",
      "parentUuid": "6a5b195b_ceb01e6b",
      "range": {
        "startLine": 48,
        "startChar": 52,
        "endLine": 48,
        "endChar": 53
      },
      "revId": "ca268841de1450aa72c542d44895b920d13ea77c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}